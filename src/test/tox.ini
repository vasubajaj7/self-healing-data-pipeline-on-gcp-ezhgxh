[tox]
envlist = py39,py310,lint,type,performance,e2e
isolated_build = true
skip_missing_interpreters = true
requires = 
    tox-conda>=0.9.2

[testenv]
deps = -r{toxinidir}/requirements.txt
commands = pytest {posargs:unit} --cov=src/backend --cov-report=term --cov-report=xml --cov-report=html
setenv = 
    PYTHONPATH = {toxinidir}/..
    TEST_ENV = development
passenv = 
    GOOGLE_APPLICATION_CREDENTIALS
    GOOGLE_CLOUD_PROJECT
    TEST_*

[testenv:py39]
basepython = python3.9
description = Run tests with Python 3.9

[testenv:py310]
basepython = python3.10
description = Run tests with Python 3.10

[testenv:lint]
description = Run linting checks
deps = 
    black>=23.3.0
    isort>=5.12.0
    flake8>=6.0.0
commands = 
    black --check --diff {toxinidir}
    isort --check --diff {toxinidir}
    flake8 {toxinidir}
skip_install = true

[testenv:type]
description = Run type checking
deps = mypy>=1.3.0
commands = mypy {toxinidir}
skip_install = true

[testenv:integration]
description = Run integration tests
commands = pytest {posargs:integration} --cov=src/backend --cov-report=term --cov-report=xml --cov-report=html
setenv = 
    PYTHONPATH = {toxinidir}/..
    TEST_ENV = development

[testenv:performance]
description = Run performance tests
deps = 
    -r{toxinidir}/requirements.txt
    locust>=2.15.0
commands = pytest {posargs:performance} --no-cov
setenv = 
    PYTHONPATH = {toxinidir}/..
    TEST_ENV = development
    TEST_DATA_SIZE = small

[testenv:e2e]
description = Run end-to-end tests
deps = 
    -r{toxinidir}/requirements.txt
    playwright>=1.33.0
    pytest-playwright>=0.3.3
commands = 
    playwright install
    pytest {posargs:e2e} --no-cov
setenv = 
    PYTHONPATH = {toxinidir}/..
    TEST_ENV = development
    HEADLESS = true

[testenv:all]
description = Run all tests
deps = 
    -r{toxinidir}/requirements.txt
    locust>=2.15.0
    playwright>=1.33.0
    pytest-playwright>=0.3.3
commands = 
    playwright install
    {toxinidir}/scripts/run_all_tests.sh
setenv = 
    PYTHONPATH = {toxinidir}/..
    TEST_ENV = development

[testenv:docs]
description = Generate test documentation
deps = 
    sphinx>=6.1.3
    sphinx-rtd-theme>=1.2.0
commands = sphinx-build -b html {toxinidir}/docs {toxinidir}/docs/_build/html
skip_install = true

[flake8]
max-line-length = 100
extend-ignore = E203,E501
exclude = .git,__pycache__,build,dist